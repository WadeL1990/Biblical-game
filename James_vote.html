<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœŸé“ä¹‹ç…‰ï¼šåœ˜é«”æ±ºç­–ç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --bg-color: #2c2c2c;
            --card-bg: #f4e4bc;
            --text-color: #3b2f2f;
            --accent-color: #8b0000;
            --btn-bg: #5d4037;
        }

        body {
            background-color: var(--bg-color);
            font-family: "Songti TC", "Noto Serif TC", serif;
            margin: 0;
            padding: 20px;
            color: white;
            text-align: center;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* ç‹€æ…‹å¡ç‰‡ */
        .card {
            background-color: var(--card-bg);
            color: var(--text-color);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            margin-bottom: 20px;
            text-align: left;
        }

        h1, h2 { text-align: center; color: var(--accent-color); }
        
        .stats-bar {
            display: flex;
            justify-content: space-around;
            background: rgba(0,0,0,0.1);
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .vote-bar-container {
            margin-top: 15px;
            background: #ddd;
            height: 25px;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .vote-bar-fill {
            height: 100%;
            background: var(--accent-color);
            width: 0%;
            transition: width 0.5s;
        }

        .vote-count {
            position: absolute;
            right: 10px;
            top: 2px;
            font-size: 0.8em;
            color: #fff;
            text-shadow: 1px 1px 2px black;
        }

        button {
            background-color: var(--btn-bg);
            color: #fff;
            border: none;
            padding: 15px;
            width: 100%;
            margin-top: 10px;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            transition: 0.2s;
        }
        button:hover { background-color: #795548; }
        button:disabled { background-color: #999; cursor: not-allowed; }

        #qrcode {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            padding: 10px;
            background: white;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
            border-radius: 5px;
        }

        .hidden { display: none; }
        
        /* æŠ•ç¥¨è€…ä»‹é¢ç‰¹åˆ¥æ¨£å¼ */
        .voter-mode .story-text { font-size: 0.9em; color: #555; }
        .voter-mode h1 { font-size: 1.5em; }

        .waiting-screen {
            text-align: center;
            padding: 50px;
            font-style: italic;
        }

        .log-area {
            font-size: 0.8em;
            color: #888;
            margin-top: 20px;
            text-align: center;
        }
    </style>
</head>
<body>

<div class="container">
    
    <div id="lobby-screen">
        <h1>ğŸ›ï¸ çœŸé“ä¹‹ç…‰ï¼šå¤šäººé€£ç·šç‰ˆ</h1>
        <div class="card" style="text-align: center;">
            <p>è«‹é¸æ“‡æ‚¨çš„èº«ä»½</p>
            <button onclick="startAsHost()">æˆ‘æ˜¯ä¸»æŒäºº (é›»è…¦/å¤§è¢å¹•)</button>
            <p style="font-size: 0.8em; color: #666; margin-top: 10px;">(è«‹ç¢ºä¿å°‡æ­¤æª”æ¡ˆä¸Šå‚³è‡³ç¶²è·¯ç©ºé–“ï¼Œæ‰‹æ©Ÿæ‰èƒ½é€£å…¥)</p>
        </div>
    </div>

    <div id="host-screen" class="hidden">
        <div class="card">
            <h2>ğŸ“¡ ç­‰å¾…æœƒçœ¾åŠ å…¥...</h2>
            <p style="text-align: center;">è«‹åƒåŠ è€…æƒææ­¤ QR Code åŠ å…¥éŠæˆ²ï¼š</p>
            <div id="qrcode"></div>
            <p style="text-align: center;">ç›®å‰é€£ç·šäººæ•¸: <span id="connection-count">0</span> äºº</p>
            <button onclick="startGame()">é–‹å§‹éŠæˆ²</button>
        </div>
    </div>

    <div id="game-screen" class="hidden">
        <div class="card">
            <div class="stats-bar">
                <span>ğŸ•Šï¸ æ™ºæ…§: <span id="stat-w">5</span></span>
                <span>ğŸ”¥ ä¿¡å¿ƒ: <span id="stat-f">5</span></span>
            </div>
            <div id="story-content" class="story-text"></div>
        </div>

        <div id="choices-area" class="card">
            </div>
    </div>

    <div id="waiting-screen" class="hidden card waiting-screen">
        <h3>â³ è«‹çœ‹å¤§è¢å¹•...</h3>
        <p>æ­£åœ¨ç­‰å¾…ä¸»æŒäººæ¨é€²åŠ‡æƒ…</p>
    </div>

    <div class="log-area" id="status-log">ç³»çµ±æº–å‚™å°±ç·’...</div>
</div>

<script>
    // --- éŠæˆ²è³‡æ–™åº« (èˆ‡ä¹‹å‰ç›¸åŒ) ---
    const scenes = {
        'start': {
            text: `ã€ç¬¬ä¸€å¹•ï¼šè©¦ç…‰çš„é¢¨æš´ã€‘<br>å†°é›¹æ‘§æ¯€äº†è‘¡è„åœ’ã€‚è¥¿é–€æ†¤æ€’åœ°å–Šé“ï¼šã€Œç¦±å‘Šæœ‰ä½•ç”¨ï¼Ÿä¸å¦‚å»å€Ÿé«˜åˆ©è²¸ï¼ã€<br>èº«ç‚ºé•·è€ï¼Œä½ æ±ºå®šï¼š`,
            choices: [
                { id: 0, text: "å®‰æ’«çœ¾äººï¼Œæ•™å°åœ¨è©¦ç…‰ä¸­å–œæ¨‚", effect: { w: 2, f: 1 }, next: "chapter2_good" },
                { id: 1, text: "é †æ‡‰æ°‘æ„ï¼Œå»æ‰¾åœ°ä¸»å€Ÿè²¸", effect: { w: 0, f: -2 }, next: "chapter2_debt" },
                { id: 2, text: "åš´å²æ–¥è²¬ï¼Œèªç‚ºé€™æ˜¯ç¥çš„æ‡²ç½°", effect: { w: -2, f: 0 }, next: "chapter2_conflict" }
            ]
        },
        'chapter2_good': {
            text: `ã€ç¬¬äºŒå¹•ï¼šå¤–è²Œå¾…äººã€‘<br>èšæœƒæ™‚ï¼ŒåŸ·äº‹è«‹å¯Œäººåä¸Šåº§ï¼Œå»å«çª®äººåè…³å‡³é‚Šã€‚ä½ æœƒï¼š`,
            choices: [
                { id: 0, text: "ä»‹å…¥ï¼Œæ•™å°ä¸å¯æŒ‰å¤–è²Œå¾…äºº", effect: { w: 2, f: 2 }, next: "chapter3" },
                { id: 1, text: "é»˜è¨±ï¼Œç‚ºäº†çˆ­å–å¯Œäººè³‡åŠ©", effect: { w: -1, f: -2 }, next: "chapter3" }
            ]
        },
        'chapter2_debt': {
            text: `ã€ç¬¬äºŒå¹•ï¼šå¯Œäººçš„å£“è¿«ã€‘<br>å‚µä¸»åœ¨èšæœƒä¸­ç¾è¾±æ¬ å‚µçš„çª®å¼Ÿå…„ã€‚ä½ æ€éº¼åšï¼Ÿ`,
            choices: [
                { id: 0, text: "ä¿æŒæ²ˆé»˜ï¼Œé¿å…æƒ¹æ€’å‚µä¸»", effect: { w: -1, f: -2 }, next: "chapter3_weak" },
                { id: 1, text: "å‹‡æ•¢æŒ‡å‡ºå¯Œäººçš„éŒ¯èª¤", effect: { w: 1, f: 3 }, next: "chapter3" }
            ]
        },
        'chapter2_conflict': {
            text: `ã€ç¬¬äºŒå¹•ï¼šè½é“èˆ‡è¡Œé“ã€‘<br>æœƒçœ¾åªé‡å„€å¼ä¸é¡˜åŠ©äººã€‚æœ‰äººèªªï¼šã€Œæœ‰ä¿¡å¿ƒå°±å¤ äº†ã€ã€‚ä½ æ•™å°ï¼š`,
            choices: [
                { id: 0, text: "ä¿¡å¿ƒæ²’æœ‰è¡Œç‚ºæ˜¯æ­»çš„", effect: { w: 1, f: 2 }, next: "chapter3" },
                { id: 1, text: "åªè¦ç¥å­¸æ­£ç¢ºå°±å¥½", effect: { w: 1, f: -1 }, next: "chapter3_weak" }
            ]
        },
        'chapter3': {
            text: `ã€ç¬¬ä¸‰å¹•ï¼šèˆŒé ­çš„ç«ã€‘<br>å…©ä½æ•™å¸«çˆ­åµï¼Œäº’ç›¸å’’è©›ã€‚ä½ å¦‚ä½•å¹³æ¯ï¼Ÿ`,
            choices: [
                { id: 0, text: "ç”¨æ¬Šå¨å£“å€’ä»–å€‘", effect: { w: -3, f: -1 }, next: "ending" },
                { id: 1, text: "æº«æŸ”å‹¸å‹‰ï¼Œå°‹æ±‚ä¸Šé ­çš„æ™ºæ…§", effect: { w: 3, f: 1 }, next: "ending" }
            ]
        },
        'chapter3_weak': {
            text: `ã€ç¬¬ä¸‰å¹•ï¼šè«–æ–·èˆ‡é©•å‚²ã€‘<br>å¤§å®¶äº’ç›¸è«–æ–·ï¼Œä¸”é©•å‚²åœ°è¨ˆåŠƒå°‡ä¾†ã€‚ä½ èªªï¼š`,
            choices: [
                { id: 0, text: "ä½ å€‘ç•¶èªªï¼šä¸»è‹¥é¡˜æ„...", effect: { w: 2, f: 1 }, next: "ending" },
                { id: 1, text: "éš¨ä»–å€‘å»å§", effect: { w: -2, f: -2 }, next: "ending" }
            ]
        },
        'ending': { text: "çµå±€ç”Ÿæˆä¸­...", choices: [] }
    };

    // --- ç³»çµ±è®Šæ•¸ ---
    let myPeer = null;
    let hostConn = null; // ç©å®¶ç«¯ï¼šé€£æ¥åˆ°ä¸»æ©Ÿçš„é€£ç·š
    let clientConns = []; // ä¸»æ©Ÿç«¯ï¼šæ‰€æœ‰ç©å®¶é€£ç·š
    let isHost = false;
    
    let gameState = {
        wisdom: 5,
        faith: 5,
        currentSceneId: 'start',
        votes: {} // { choiceId: count }
    };

    // --- åˆå§‹åŒ– ---
    // æª¢æŸ¥ç¶²å€æ˜¯å¦æœ‰ ?host=IDï¼Œè‹¥æœ‰å‰‡è‡ªå‹•é€²å…¥ç©å®¶æ¨¡å¼
    window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        const hostId = urlParams.get('host');
        if (hostId) {
            startAsVoter(hostId);
        }
    };

    function log(msg) {
        document.getElementById('status-log').innerText = msg;
        console.log(msg);
    }

    // --- ä¸»æŒäººé‚è¼¯ ---
    function startAsHost() {
        isHost = true;
        document.getElementById('lobby-screen').classList.add('hidden');
        document.getElementById('host-screen').classList.remove('hidden');
        
        // åˆå§‹åŒ– Peer (éš¨æ©Ÿ ID)
        myPeer = new Peer(generateRandomId(), { debug: 2 });

        myPeer.on('open', (id) => {
            log(`ä¸»æ©Ÿå·²å»ºç«‹ï¼ŒID: ${id}`);
            // ç”Ÿæˆ QR Code
            const joinUrl = `${window.location.href.split('?')[0]}?host=${id}`;
            new QRCode(document.getElementById("qrcode"), {
                text: joinUrl,
                width: 180,
                height: 180
            });
        });

        myPeer.on('connection', (conn) => {
            clientConns.push(conn);
            updateConnectionCount();
            
            conn.on('data', (data) => {
                handleDataFromClient(data);
            });

            conn.on('close', () => {
                clientConns = clientConns.filter(c => c !== conn);
                updateConnectionCount();
            });
            
            // è‹¥éŠæˆ²å·²ç¶“é–‹å§‹ï¼Œå‚³é€ç•¶å‰ç‹€æ…‹çµ¦æ–°åŠ å…¥è€…
            if(!document.getElementById('game-screen').classList.contains('hidden')) {
                 sendStateToClient(conn);
            }
        });
    }

    function updateConnectionCount() {
        document.getElementById('connection-count').innerText = clientConns.length;
    }

    function startGame() {
        document.getElementById('host-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        renderSceneHost('start');
    }

    function renderSceneHost(sceneId) {
        gameState.currentSceneId = sceneId;
        gameState.votes = {}; // é‡ç½®æŠ•ç¥¨

        // æ¸²æŸ“ä¸»æ©Ÿç•«é¢
        if (sceneId === 'ending') {
            showEndingHost();
            broadcast({ type: 'SCENE', sceneId: 'ending', text: document.getElementById('story-content').innerHTML });
            return;
        }

        const scene = scenes[sceneId];
        document.getElementById('story-content').innerHTML = scene.text;
        updateStatsUI();

        const choicesArea = document.getElementById('choices-area');
        choicesArea.innerHTML = `<h3>ğŸ“Š å³æ™‚æŠ•ç¥¨çµæœ</h3>`;
        
        scene.choices.forEach((choice, index) => {
            // å‰µå»ºæŠ•ç¥¨æ¢
            const div = document.createElement('div');
            div.innerHTML = `
                <div style="margin-bottom: 5px;">${choice.text}</div>
                <div class="vote-bar-container">
                    <div id="bar-${index}" class="vote-bar-fill"></div>
                    <span id="count-${index}" class="vote-count">0 ç¥¨</span>
                </div>
            `;
            choicesArea.appendChild(div);
            gameState.votes[index] = 0;
        });

        // æ·»åŠ ã€Œçµç®—ã€æŒ‰éˆ•
        const nextBtn = document.createElement('button');
        nextBtn.innerText = "ğŸ›‘ åœæ­¢æŠ•ç¥¨ä¸¦çµç®— (é¸æ“‡æœ€é«˜ç¥¨)";
        nextBtn.style.backgroundColor = "#d32f2f";
        nextBtn.style.marginTop = "20px";
        nextBtn.onclick = concludeVote;
        choicesArea.appendChild(nextBtn);

        // å»£æ’­çµ¦æ‰€æœ‰ç©å®¶
        broadcast({
            type: 'SCENE',
            sceneId: sceneId,
            text: scene.text,
            choices: scene.choices
        });
    }

    function handleDataFromClient(data) {
        if (data.type === 'VOTE') {
            const choiceId = data.choiceId;
            gameState.votes[choiceId] = (gameState.votes[choiceId] || 0) + 1;
            updateVoteUI();
        }
    }

    function updateVoteUI() {
        const totalVotes = Object.values(gameState.votes).reduce((a, b) => a + b, 0);
        for (let id in gameState.votes) {
            const count = gameState.votes[id];
            const percent = totalVotes === 0 ? 0 : (count / totalVotes) * 100;
            
            const bar = document.getElementById(`bar-${id}`);
            const text = document.getElementById(`count-${id}`);
            if (bar) bar.style.width = `${percent}%`;
            if (text) text.innerText = `${count} ç¥¨`;
        }
    }

    function concludeVote() {
        // æ‰¾å‡ºæœ€é«˜ç¥¨
        let maxVotes = -1;
        let winnerId = 0;
        
        // ç°¡å–®é‚è¼¯ï¼šè‹¥å¹³ç¥¨å–ç¬¬ä¸€å€‹ï¼Œè‹¥ç„¡äººæŠ•å–ç¬¬ä¸€å€‹
        for (let id in gameState.votes) {
            if (gameState.votes[id] > maxVotes) {
                maxVotes = gameState.votes[id];
                winnerId = id;
            }
        }
        
        const scene = scenes[gameState.currentSceneId];
        const choice = scene.choices[winnerId];
        
        alert(`æŠ•ç¥¨çµæœï¼š${choice.text}`);
        
        // æ›´æ–°æ•¸å€¼
        gameState.wisdom += choice.effect.w;
        gameState.faith += choice.effect.f;
        
        // é€²å…¥ä¸‹ä¸€å¹•
        renderSceneHost(choice.next);
    }

    // --- ç©å®¶ (Voter) é‚è¼¯ ---
    function startAsVoter(hostId) {
        document.getElementById('lobby-screen').classList.add('hidden');
        document.body.classList.add('voter-mode');
        document.getElementById('waiting-screen').classList.remove('hidden');
        log("æ­£åœ¨é€£ç·šåˆ°ä¸»æ©Ÿ...");

        myPeer = new Peer({ debug: 2 }); // è‡ªå‹•ç”Ÿæˆ ID

        myPeer.on('open', () => {
            hostConn = myPeer.connect(hostId);
            
            hostConn.on('open', () => {
                log("å·²é€£ç·šï¼ç­‰å¾…éŠæˆ²é–‹å§‹...");
                document.getElementById('waiting-screen').querySelector('h3').innerText = "âœ… å·²é€£ç·š";
            });

            hostConn.on('data', (data) => {
                handleDataFromHost(data);
            });
            
            hostConn.on('close', () => {
                alert("èˆ‡ä¸»æŒäººæ–·ç·š");
                location.reload();
            });
        });
    }

    function handleDataFromHost(data) {
        if (data.type === 'SCENE') {
            if (data.sceneId === 'ending') {
                document.getElementById('waiting-screen').classList.add('hidden');
                document.getElementById('game-screen').classList.remove('hidden');
                document.getElementById('story-content').innerHTML = data.text;
                document.getElementById('choices-area').innerHTML = "";
                return;
            }

            // é¡¯ç¤ºé¡Œç›®èˆ‡é¸é …
            document.getElementById('waiting-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            
            document.getElementById('story-content').innerHTML = data.text;
            
            const optionsDiv = document.getElementById('choices-area');
            optionsDiv.innerHTML = '';
            
            data.choices.forEach((choice, index) => {
                const btn = document.createElement('button');
                btn.innerText = choice.text;
                btn.onclick = () => {
                    sendVote(index);
                    // é–å®šæŒ‰éˆ•é¿å…é‡è¤‡æŠ•
                    const allBtns = optionsDiv.querySelectorAll('button');
                    allBtns.forEach(b => b.disabled = true);
                    btn.innerText += " (å·²é€å‡º)";
                    btn.style.backgroundColor = "#2e7d32";
                };
                optionsDiv.appendChild(btn);
            });
        }
    }

    function sendVote(choiceId) {
        hostConn.send({ type: 'VOTE', choiceId: choiceId });
        document.getElementById('status-log').innerText = "æŠ•ç¥¨å·²é€å‡ºï¼Œç­‰å¾…çµæœ...";
    }

    // --- å·¥å…·å‡½æ•¸ ---
    function broadcast(data) {
        clientConns.forEach(conn => {
            if(conn.open) conn.send(data);
        });
    }

    function sendStateToClient(conn) {
        // ç°¡å–®ç‰ˆï¼šåªè¦ä¸æ˜¯ endingï¼Œå°±é‡ç™¼ä¸€æ¬¡ç•¶å‰å ´æ™¯
        const sceneId = gameState.currentSceneId;
        if (scenes[sceneId]) {
            conn.send({
                type: 'SCENE',
                sceneId: sceneId,
                text: scenes[sceneId].text,
                choices: scenes[sceneId].choices
            });
        }
    }

    function updateStatsUI() {
        document.getElementById('stat-w').innerText = gameState.wisdom;
        document.getElementById('stat-f').innerText = gameState.faith;
    }

    function showEndingHost() {
        let title, desc, verse;
        // åˆ¤æ–·çµå±€é‚è¼¯ (èˆ‡å–®äººç‰ˆç›¸åŒ)
        const w = gameState.wisdom;
        const f = gameState.faith;

        if (w >= 8 && f >= 8) {
            title = "çµå±€ï¼šè½é“ä¸”è¡Œé“çš„äºº";
            desc = "æ•™æœƒåœ¨è©¦ç…‰ä¸­è¢«ç…‰æ·¨ï¼Œæˆç‚ºç¤¾å€çš„å…‰ã€‚";
            verse = "(é›… 2:26)";
        } else if (f < 4) {
            title = "çµå±€ï¼šæ­»çš„ä¿¡å¿ƒ";
            desc = "æ•™æœƒé›–ç„¶å­˜æ´»ï¼Œå»å¤±å»äº†å±¬éˆçš„åŠ›é‡ï¼Œèˆ‡ä¸–ä¿—ç„¡ç•°ã€‚";
            verse = "(é›… 2:17)";
        } else if (w < 4) {
            title = "çµå±€ï¼šå±¬åœ°çš„ç´›çˆ­";
            desc = "è¡€æ°£èˆ‡åš´å²å°è‡´äº†æ•™æœƒçš„åˆ†è£‚ã€‚";
            verse = "(é›… 4:1)";
        } else {
            title = "çµå±€ï¼šåœ¨è»Ÿå¼±ä¸­æˆé•·";
            desc = "é›–ç„¶è·Œè·Œæ’æ’ï¼Œä½†ç¥ä»åœ¨å‹•å·¥ã€‚";
            verse = "(é›… 1:12)";
        }

        const html = `
            <h2 style="color:var(--accent-color)">${title}</h2>
            <p>${desc}</p>
            <p><b>${verse}</b></p>
            <p>æœ€çµ‚æ•¸å€¼ - æ™ºæ…§: ${w} | ä¿¡å¿ƒ: ${f}</p>
            <button onclick="location.reload()">é‡æ–°é–‹å§‹</button>
        `;
        
        document.getElementById('story-content').innerHTML = html;
        document.getElementById('choices-area').innerHTML = '';
    }

    function generateRandomId() {
        return Math.random().toString(36).substring(2, 6).toUpperCase();
    }

</script>

</body>
</html>